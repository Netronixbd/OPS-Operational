<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ops Provisioning Pro | v3.0 Master Sort</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; color: #1e293b; min-height: 100vh; background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 20px 20px; display: flex; flex-direction: column; }
        .login-screen { background: linear-gradient(135deg, #020617 0%, #1e1b4b 100%); }
        .glass-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 1.5rem; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05); }
        .alarm-row { border: 2px solid #ef4444 !important; background: #fef2f2 !important; animation: pulse-red 2s infinite; }
        .network-animate { animation: pulse-network 2s infinite; }
        @keyframes pulse-network { 0% { transform: scale(1); filter: drop-shadow(0 0 0px #6366f1); } 50% { transform: scale(1.1); filter: drop-shadow(0 0 15px #6366f1); } 100% { transform: scale(1); filter: drop-shadow(0 0 0px #6366f1); } }
        .hidden { display: none !important; }
        input, select, textarea { background: #ffffff !important; border: 1px solid #e2e8f0 !important; color: #1e293b !important; font-size: 14px; transition: all 0.2s; }
        .service-card { background: #ffffff; padding: 15px; border-radius: 1rem; border: 1px solid #f1f5f9; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .notification-badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; font-weight: bold; }
        footer { margin-top: auto; padding: 20px; text-align: center; background: rgba(2, 6, 23, 0.05); border-top: 1px solid #e2e8f0; font-size: 12px; font-weight: 700; color: #64748b; letter-spacing: 0.5px; }
        footer span { color: #6366f1; }
    </style>
</head>
<body>

    <div id="loginPage" class="fixed inset-0 z-[5000] login-screen flex flex-col items-center justify-center p-6 text-white text-center">
        <div class="max-w-md w-full bg-white/5 backdrop-blur-2xl p-10 rounded-[2.5rem] border border-white/10 shadow-2xl">
            <div class="bg-indigo-600 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-4 network-animate">
                <i class="fas fa-network-wired text-3xl"></i>
            </div>
            <h2 class="text-3xl font-black uppercase tracking-tighter mb-2">Ops <span class="text-indigo-400">Login</span></h2>
            <form id="loginForm" class="space-y-4">
                <input type="text" id="username" placeholder="Username" class="w-full p-4 rounded-2xl bg-white/5 border border-white/10 text-white outline-none" required>
                <input type="password" id="password" placeholder="Password" class="w-full p-4 rounded-2xl bg-white/5 border border-white/10 text-white outline-none" required>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 py-4 rounded-2xl font-black uppercase tracking-widest transition-all">Enter System</button>
            </form>
            <p id="loginError" class="text-rose-400 text-xs font-bold mt-4 hidden">Invalid Credentials!</p>
        </div>
        <p class="mt-6 text-[10px] text-white/30 uppercase tracking-[3px] font-bold">Powered by Amir Hosan Jesan</p>
    </div>

    <div id="dashboard" class="hidden flex-1">
        <header class="container mx-auto mt-6 mb-8 flex flex-col md:flex-row justify-between items-center px-4 gap-6">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-600 p-3 rounded-2xl text-white shadow-lg"><i class="fas fa-network-wired text-2xl"></i></div>
                <div>
                    <h1 class="text-3xl font-extrabold tracking-tight text-slate-900">Network <span class="text-indigo-600">Compliance</span></h1>
                    <p id="userStatus" class="text-slate-400 text-[10px] uppercase tracking-widest font-bold"></p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="showAuditLogs()" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-slate-400 hover:text-indigo-600 transition-all"><i class="fas fa-history text-xl"></i></button>
                <div class="relative">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100"><i class="fas fa-bell text-slate-400 text-xl"></i><span id="expiredCount" class="notification-badge">0</span></div>
                </div>
                <div id="clock" class="text-xl font-mono font-bold bg-white text-indigo-600 px-6 py-3 rounded-2xl border border-slate-100 shadow-sm">00:00:00</div>
                <button onclick="logout()" class="bg-rose-50 text-rose-500 p-4 rounded-2xl hover:bg-rose-100 transition-all"><i class="fas fa-power-off"></i></button>
            </div>
        </header>

        <main class="container mx-auto px-4 pb-20">
            <section id="formSection" class="glass-panel p-8 mb-8">
                <form id="multiServiceForm">
                    <input type="hidden" id="editEntryId" value="">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Client Name</label><input type="text" id="custName" class="w-full rounded-xl p-3 shadow-sm" placeholder="Client Identity *" required></div>
                        <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Requestor (Approval)</label>
                            <select id="requestedBy" class="w-full rounded-xl p-3 shadow-sm" onchange="checkOthers(this.value)" required>
                                <option value="">Select Requestor *</option><option value="Marketing Concern">Marketing Concern</option><option value="Team Leader">Team Leader</option><option value="Customer Request">Customer Request</option><option value="Others">Others</option>
                            </select>
                            <input type="text" id="othersInput" class="w-full rounded-xl p-3 mt-2 hidden" placeholder="Name?">
                        </div>
                        <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Executing Engineer</label>
                            <select id="executedBy" class="w-full rounded-xl p-3 shadow-sm engineer-select" required>
                                <option value="">Select Engineer *</option>
                            </select>
                        </div>
                    </div>
                    <div id="serviceGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8"></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex items-center gap-4">
                            <i class="fas fa-clock text-indigo-400"></i>
                            <div class="flex-1">
                                <label class="text-[10px] font-bold uppercase text-slate-400 block mb-1">Expiry Duration</label>
                                <div class="flex gap-2">
                                    <input type="number" id="durVal" class="w-20 p-2 rounded-lg font-bold" value="1" required>
                                    <select id="durUnit" class="flex-1 p-2 rounded-lg font-medium"><option value="hours">Hours</option><option value="days">Days</option></select>
                                </div>
                            </div>
                        </div>
                        <textarea id="reason" class="w-full rounded-2xl p-4 shadow-sm" placeholder="Reference or Reason for provisioning..."></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button type="submit" id="submitBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-2xl font-bold uppercase tracking-widest shadow-lg mt-6 transition-all">Generate Provisioning Rule</button>
                        <button type="button" id="cancelEditBtn" onclick="resetProvisionForm()" class="hidden bg-slate-200 hover:bg-slate-300 text-slate-600 px-8 rounded-2xl font-bold uppercase tracking-widest mt-6 transition-all">Cancel</button>
                    </div>
                </form>
            </section>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-6">
                <div class="relative md:col-span-6">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="searchClient" onkeyup="filterDatabase()" placeholder="Search client name..." class="w-full pl-12 pr-4 py-4 rounded-2xl shadow-sm border-none bg-white font-medium">
                </div>
                <div class="md:col-span-3">
                    <select id="statusFilter" onchange="filterDatabase()" class="w-full bg-white px-6 py-4 rounded-2xl shadow-sm border-none font-bold text-slate-500 text-xs uppercase cursor-pointer">
                        <option value="all">All Status</option>
                        <option value="active">Active Only</option>
                        <option value="expired">Expired Only</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="md:col-span-3">
                    <select id="serviceTypeFilter" onchange="filterDatabase()" class="w-full bg-white px-6 py-4 rounded-2xl shadow-sm border-none font-bold text-indigo-600 text-xs uppercase cursor-pointer">
                        <option value="all">All Service Types</option>
                        <option value="IPT">IPT</option><option value="GGC">GGC</option><option value="FNA">FNA</option><option value="BDIX">BDIX</option><option value="CDN">CDN</option><option value="AKAMAI">AKAMAI</option><option value="PNI">PNI</option><option value="BCDN">BCDN</option>
                    </select>
                </div>
            </div>

            <div class="glass-panel overflow-hidden mb-10">
                <table class="w-full text-left">
                    <thead class="bg-slate-50/50 border-b border-slate-100 text-[11px] font-bold uppercase text-slate-400">
                        <tr>
                            <th class="px-6 py-4">Client Details</th>
                            <th class="px-6 py-4">Service Status & BW</th>
                            <th class="px-6 py-4 text-center">Time Remaining</th>
                            <th class="px-6 py-4 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dbBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>

            <div id="superAdminSection" class="hidden space-y-8">
                <section class="glass-panel p-8 border-2 border-indigo-100">
                    <h3 class="text-xl font-black text-indigo-600 uppercase mb-6 flex items-center gap-3"><i class="fas fa-users-cog"></i> User Management</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <input type="text" id="newUname" placeholder="Username" class="p-3 rounded-xl shadow-sm">
                        <input type="password" id="newPass" placeholder="Password" class="p-3 rounded-xl shadow-sm">
                        <select id="newRole" class="p-3 rounded-xl shadow-sm"><option value="write">Write</option><option value="read">Read</option></select>
                        <button onclick="addUser()" class="bg-indigo-600 text-white rounded-xl font-bold uppercase text-xs">Add User</button>
                    </div>
                    <div id="userList" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
                </section>
                <section class="glass-panel p-8 border-2 border-emerald-100">
                    <h3 class="text-xl font-black text-emerald-600 uppercase mb-6 flex items-center gap-3"><i class="fas fa-user-tie"></i> Engineer Management</h3>
                    <div class="flex gap-4 mb-6">
                        <input type="text" id="newEngName" placeholder="Engineer Name" class="flex-1 p-3 rounded-xl shadow-sm">
                        <button onclick="addEngineer()" class="bg-emerald-600 text-white px-6 rounded-xl font-bold uppercase text-xs">Add Engineer</button>
                    </div>
                    <div id="engineerList" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
                </section>
            </div>
        </main>
    </div>

    <footer>© 2026 Ops Provisioning Pro | <span>Powered by Amir Hosan Jesan</span></footer>

    <div id="modal" class="fixed inset-0 z-[6000] hidden flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm">
        <div class="bg-white max-w-lg w-full rounded-3xl p-8 shadow-2xl border border-slate-200">
            <h3 id="modalTitle" class="text-2xl font-black text-slate-800 mb-6 uppercase tracking-tight">Provisioning Details</h3>
            <div id="modalContent" class="space-y-4 overflow-y-auto max-h-[60vh]"></div>
            <div id="modalFooter" class="mt-8">
                <button onclick="closeModal()" class="w-full bg-slate-100 p-4 rounded-2xl font-bold text-slate-500 uppercase text-xs hover:bg-slate-200 transition-all">Close Window</button>
            </div>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('ops_provision_v2')) || [];
        let appUsers = JSON.parse(localStorage.getItem('ops_app_users')) || [{ uname: 'SuperAdmin', pass: 'Root@Admin', role: 'super' }];
        let engineers = JSON.parse(localStorage.getItem('ops_engineers')) || ["MR. Amir Hosan", "MR. Niaz Morshed", "MR. Abdullah Al Mamun", "MR. Mahmudul Hasan"];
        let auditLogs = JSON.parse(localStorage.getItem('ops_audit_logs')) || [];
        let currentUser = null;
        const services = ['IPT', 'GGC', 'FNA', 'BDIX', 'CDN', 'AKAMAI', 'PNI', 'BCDN'];

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const user = appUsers.find(x => x.uname === document.getElementById('username').value && x.pass === document.getElementById('password').value);
            if(user) { currentUser = user; document.getElementById('loginPage').classList.add('hidden'); document.getElementById('dashboard').classList.remove('hidden'); initSystem(); }
            else { document.getElementById('loginError').classList.remove('hidden'); }
        });

        function logout() { location.reload(); }

        function initSystem() {
            document.getElementById('userStatus').innerText = `Logged in as: ${currentUser.uname} (${currentUser.role})`;
            if(currentUser.role === 'read') {
                document.getElementById('formSection').classList.add('hidden');
                document.getElementById('superAdminSection').classList.add('hidden');
            } else if(currentUser.role === 'super') { 
                document.getElementById('superAdminSection').classList.remove('hidden'); 
                document.getElementById('formSection').classList.remove('hidden');
                renderUserList(); 
                renderEngineerList();
            } else {
                document.getElementById('formSection').classList.remove('hidden');
                document.getElementById('superAdminSection').classList.add('hidden');
            }
            renderEngineerSelect();
            renderServiceGrid();
            saveAndRender();
        }

        function renderServiceGrid() {
            const grid = document.getElementById('serviceGrid');
            grid.innerHTML = services.map(s => `
                <div class="service-card">
                    <div class="flex justify-between items-center mb-3">
                        <span class="font-bold text-sm text-indigo-600">${s}</span>
                        <select id="${s}_mode" class="p-1 rounded text-[10px] bg-slate-50" onchange="toggleInputs('${s}')">
                            <option value="">No Change</option><option value="Uncap">Uncapped</option><option value="Modified">Modified</option>
                        </select>
                    </div>
                    <div id="${s}_fields" class="space-y-2 hidden">
                        <input type="number" id="${s}_mod" class="p-2 rounded-lg w-full text-xs" placeholder="Upgrade BW">
                        <input type="number" id="${s}_purchase" class="p-2 rounded-lg w-full text-xs border-dashed" placeholder="Original BW">
                    </div>
                </div>`).join('');
        }

        function renderEngineerSelect() {
            const selects = document.querySelectorAll('.engineer-select');
            selects.forEach(select => {
                const currentVal = select.value;
                select.innerHTML = '<option value="">Select Engineer *</option>' + engineers.map(e => `<option value="${e}">${e}</option>`).join('');
                if(currentVal) select.value = currentVal;
            });
        }

        function renderEngineerList() {
            if(currentUser.role !== 'super') return;
            document.getElementById('engineerList').innerHTML = engineers.map((e, i) => `
                <div class="bg-white p-3 rounded-xl border flex justify-between items-center shadow-sm">
                    <span class="font-bold text-slate-700">${e}</span>
                    <button onclick="deleteEngineer(${i})" class="text-rose-500 hover:bg-rose-50 p-2 rounded-lg"><i class="fas fa-trash"></i></button>
                </div>`).join('');
        }

        function addEngineer() {
            if(currentUser.role === 'read') return;
            const name = document.getElementById('newEngName').value.trim();
            if(!name) return alert("Enter name");
            engineers.push(name);
            localStorage.setItem('ops_engineers', JSON.stringify(engineers));
            document.getElementById('newEngName').value = '';
            renderEngineerList();
            renderEngineerSelect();
        }

        function deleteEngineer(index) {
            if(currentUser.role !== 'super') return;
            if(confirm("Remove this engineer?")) {
                engineers.splice(index, 1);
                localStorage.setItem('ops_engineers', JSON.stringify(engineers));
                renderEngineerList();
                renderEngineerSelect();
            }
        }

        function toggleInputs(s) {
            const mode = document.getElementById(`${s}_mode`).value;
            document.getElementById(`${s}_fields`).classList.toggle('hidden', mode === '');
        }

        document.getElementById('multiServiceForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if(currentUser.role === 'read') return;
            const selectedServices = [];
            let validationError = false;
            services.forEach(s => {
                const mode = document.getElementById(`${s}_mode`).value;
                if(mode) {
                    const modVal = document.getElementById(`${s}_mod`).value;
                    const purVal = document.getElementById(`${s}_purchase`).value;
                    if(mode === 'Modified' && !purVal) {
                        alert(`Please enter Original/Purchase BW for ${s}`);
                        validationError = true;
                        return;
                    }
                    selectedServices.push({ name: s, mode: mode, mod: modVal, pur: purVal });
                }
            });
            if(validationError) return;
            if(!selectedServices.length) return alert("Select at least one service!");

            const durationInMs = (document.getElementById('durVal').value * (document.getElementById('durUnit').value === 'hours' ? 3600000 : 86400000));
            const editId = document.getElementById('editEntryId').value;

            if(editId) {
                // Edit existing
                const index = db.findIndex(x => x.id == editId);
                if(index !== -1) {
                    db[index].name = document.getElementById('custName').value;
                    db[index].requestor = document.getElementById('requestedBy').value === 'Others' ? document.getElementById('othersInput').value : document.getElementById('requestedBy').value;
                    db[index].engineer = document.getElementById('executedBy').value;
                    db[index].services = selectedServices;
                    db[index].expiry = new Date().getTime() + durationInMs;
                    db[index].reason = document.getElementById('reason').value;
                    auditLogs.unshift({ action: 'Record Updated', client: db[index].name, user: currentUser.uname, time: new Date().toLocaleString() });
                }
            } else {
                // New entry
                const expiryTime = new Date().getTime() + durationInMs;
                const newEntry = {
                    id: Date.now(),
                    name: document.getElementById('custName').value,
                    requestor: document.getElementById('requestedBy').value === 'Others' ? document.getElementById('othersInput').value : document.getElementById('requestedBy').value,
                    engineer: document.getElementById('executedBy').value,
                    services: selectedServices,
                    expiry: expiryTime,
                    reason: document.getElementById('reason').value,
                    resolved: false,
                    resolvedBy: null,
                    created: new Date().toLocaleString()
                };
                db.unshift(newEntry);
                auditLogs.unshift({ action: 'Rule Provisioned', client: newEntry.name, user: currentUser.uname, time: new Date().toLocaleString() });
            }

            resetProvisionForm();
            saveAndRender();
        });

        function resetProvisionForm() {
            const form = document.getElementById('multiServiceForm');
            form.reset();
            document.getElementById('editEntryId').value = '';
            document.getElementById('submitBtn').innerText = 'Generate Provisioning Rule';
            document.getElementById('cancelEditBtn').classList.add('hidden');
            document.getElementById('othersInput').classList.add('hidden');
            services.forEach(s => { 
                document.getElementById(`${s}_fields`).classList.add('hidden');
                document.getElementById(`${s}_mode`).value = '';
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function editEntry(id) {
            const d = db.find(x => x.id === id);
            if(!d) return;

            document.getElementById('editEntryId').value = d.id;
            document.getElementById('custName').value = d.name;
            
            if(["Marketing Concern", "Team Leader", "Customer Request"].includes(d.requestor)) {
                document.getElementById('requestedBy').value = d.requestor;
                document.getElementById('othersInput').classList.add('hidden');
            } else {
                document.getElementById('requestedBy').value = "Others";
                document.getElementById('othersInput').value = d.requestor;
                document.getElementById('othersInput').classList.remove('hidden');
            }

            document.getElementById('executedBy').value = d.engineer;
            document.getElementById('reason').value = d.reason || '';
            
            // Set Services
            services.forEach(s => {
                const sData = d.services.find(serv => serv.name === s);
                const modeSelect = document.getElementById(`${s}_mode`);
                const fields = document.getElementById(`${s}_fields`);
                if(sData) {
                    modeSelect.value = sData.mode;
                    fields.classList.remove('hidden');
                    document.getElementById(`${s}_mod`).value = sData.mod || '';
                    document.getElementById(`${s}_purchase`).value = sData.pur || '';
                } else {
                    modeSelect.value = '';
                    fields.classList.add('hidden');
                }
            });

            document.getElementById('submitBtn').innerText = 'Update Provisioning Rule';
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function saveAndRender() {
            localStorage.setItem('ops_provision_v2', JSON.stringify(db));
            localStorage.setItem('ops_audit_logs', JSON.stringify(auditLogs));
            filterDatabase();
            updateNotifications();
        }

        function filterDatabase() {
            const term = document.getElementById('searchClient').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const sType = document.getElementById('serviceTypeFilter').value;
            const tbody = document.getElementById('dbBody');
            const now = new Date().getTime();

            const sortedDb = [...db].sort((a, b) => {
                const aIsExpired = (a.expiry - now) <= 0 && !a.resolved;
                const bIsExpired = (b.expiry - now) <= 0 && !b.resolved;
                if (aIsExpired && !bIsExpired) return -1;
                if (!aIsExpired && bIsExpired) return 1;
                if (!a.resolved && !b.resolved) return a.expiry - b.expiry;
                if (a.resolved && !b.resolved) return 1;
                if (!a.resolved && b.resolved) return -1;
                return 0;
            });

            const filtered = sortedDb.filter(x => {
                const matchesSearch = x.name.toLowerCase().includes(term);
                const isExpired = (x.expiry - now) <= 0 && !x.resolved;
                let matchesStatus = true;
                if (status === 'active') matchesStatus = !x.resolved && !isExpired;
                else if (status === 'expired') matchesStatus = isExpired;
                else if (status === 'completed') matchesStatus = x.resolved;
                let matchesService = sType === 'all' ? true : x.services.some(s => s.name === sType);
                return matchesSearch && matchesStatus && matchesService;
            });

            tbody.innerHTML = filtered.map((d, i) => {
                const timeLeft = d.expiry - now;
                const isExpired = timeLeft <= 0;
                const actionButtons = currentUser.role !== 'read' ? `
                    <button onclick="editEntry(${d.id})" class="text-blue-500 hover:bg-blue-50 p-2 rounded-xl"><i class="fas fa-edit"></i></button>
                    <button onclick="promptRollback(${d.id})" class="${d.resolved ? 'text-emerald-500' : 'text-slate-400'} hover:bg-slate-50 p-2 rounded-xl"><i class="fas fa-check-circle"></i></button>
                    <button onclick="deleteEntry(${d.id})" class="text-rose-500 hover:bg-rose-50 p-2 rounded-xl"><i class="fas fa-trash"></i></button>
                ` : '';

                return `<tr class="${d.resolved ? 'opacity-50 bg-slate-50' : (isExpired ? 'alarm-row' : '')}"><td class="px-6 py-5"><div class="font-bold text-slate-800">${d.name}</div><div class="text-[10px] text-slate-400 uppercase font-black">${d.engineer}</div></td><td class="px-6 py-5"><div class="flex flex-wrap gap-1">${d.services.map(s => `<div class="flex items-center gap-1 bg-white border border-slate-100 rounded-lg px-2 py-1 shadow-sm"><span class="text-[9px] font-bold text-indigo-600">${s.name}</span><span class="w-1 h-1 bg-slate-200 rounded-full"></span><span class="text-[9px] font-black ${s.mode === 'Uncap' ? 'text-emerald-500' : 'text-amber-500'} uppercase">${s.mode}</span></div>`).join('')}</div></td><td class="px-6 py-5 text-center">${d.resolved ? `<div class="flex flex-col"><span class="px-3 py-1 bg-emerald-100 text-emerald-600 rounded-full text-[10px] font-black">COMPLETED</span><span class="text-[8px] text-slate-400 mt-1 uppercase">BY: ${d.resolvedBy || 'N/A'}</span></div>` : `<div class="font-mono font-bold text-sm ${isExpired ? 'text-rose-600' : 'text-indigo-600'}">${isExpired ? 'EXPIRED' : formatTime(timeLeft)}</div>`}</td><td class="px-6 py-5 text-center flex justify-center gap-2"><button onclick="viewDetails(${d.id})" class="text-indigo-500 hover:bg-indigo-50 p-2 rounded-xl"><i class="fas fa-eye"></i></button>${actionButtons}</td></tr>`;
            }).join('');
        }

        function formatTime(ms) {
            const h = Math.floor(ms / 3600000), m = Math.floor((ms % 3600000) / 60000), s = Math.floor((ms % 60000) / 1000);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function viewDetails(id) {
            const d = db.find(x => x.id === id);
            const expiryDate = new Date(d.expiry).toLocaleString();
            document.getElementById('modalTitle').innerText = d.name;
            document.getElementById('modalContent').innerHTML = `
                <div class="bg-indigo-600 text-white p-5 rounded-3xl mb-4 shadow-lg shadow-indigo-100">
                    <p class="text-[10px] uppercase font-bold opacity-70 mb-1">Approval Body</p>
                    <h4 class="text-xl font-black uppercase tracking-tight">${d.requestor}</h4>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">Provisioned By</p>
                        <p class="text-sm font-black text-slate-700">${d.engineer}</p>
                    </div>
                    <div class="p-4 bg-rose-50 rounded-2xl border border-rose-100">
                        <p class="text-[10px] uppercase font-bold text-rose-400 mb-1">Exact Expiry Time</p>
                        <p class="text-sm font-black text-rose-700">${expiryDate}</p>
                    </div>
                </div>
                <div class="space-y-3">
                    <p class="text-[11px] font-black uppercase text-indigo-600 tracking-widest flex items-center gap-2">
                        <i class="fas fa-signal"></i> Modified Service Details
                    </p>
                    <div class="space-y-2">
                        ${d.services.map(s => `
                            <div class="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-2xl shadow-sm">
                                <div><span class="text-xs font-black text-slate-800 uppercase">${s.name}</span><span class="ml-2 px-2 py-0.5 bg-indigo-50 text-indigo-600 rounded-md text-[9px] font-bold uppercase">${s.mode}</span></div>
                                <div class="text-right">
                                    ${s.mode === 'Uncap' ? `<span class="text-xs font-black text-emerald-500 uppercase tracking-tighter">Unlimited Upgrade</span>` : `<span class="text-[10px] font-bold text-slate-400">Modified: <b class="text-amber-500">${s.pur}M</b> → <b class="text-indigo-600">${s.mod}M</b></span>`}
                                </div>
                            </div>`).join('')}
                    </div>
                </div>
                ${d.reason ? `<div class="mt-4 p-4 bg-slate-900 text-white rounded-2xl"><p class="text-[10px] uppercase font-bold opacity-50 mb-1">Reference / Note</p><p class="text-xs font-medium leading-relaxed">${d.reason}</p></div>` : ''}`;
            document.getElementById('modal').classList.remove('hidden');
        }

        function promptRollback(id) {
            if(currentUser.role === 'read') return;
            const entry = db.find(x => x.id === id);
            document.getElementById('modalTitle').innerText = entry.resolved ? "Re-activate Rule?" : "Confirm Rollback";
            document.getElementById('modalContent').innerHTML = `
                <div class="p-6 bg-amber-50 rounded-3xl border border-amber-100 text-center">
                    <i class="fas fa-exclamation-triangle text-4xl text-amber-500 mb-4"></i>
                    <p class="text-sm font-bold text-slate-700 mb-4">Are you sure you want to perform this action for <b>${entry.name}</b>?</p>
                    <div class="text-left">
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Executing Rollback Engineer *</label>
                        <select id="rollbackEng" class="w-full rounded-xl p-4 mt-1 engineer-select shadow-sm" required>
                             <option value="">Select Engineer *</option>
                        </select>
                    </div>
                </div>
                <button onclick="executeToggle(${id})" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg mt-4">Confirm Action</button>
            `;
            renderEngineerSelect();
            document.getElementById('modal').classList.remove('hidden');
        }

        function executeToggle(id) {
            if(currentUser.role === 'read') return;
            const eng = document.getElementById('rollbackEng').value;
            if(!eng) return alert("Engineer Name is mandatory!");
            const entry = db.find(x => x.id === id);
            entry.resolved = !entry.resolved;
            entry.resolvedBy = eng;
            auditLogs.unshift({ action: entry.resolved ? 'Rollback/Resolved' : 'Re-activated', client: entry.name, user: eng, time: new Date().toLocaleString() });
            saveAndRender();
            closeModal();
        }

        function deleteEntry(id) { 
            if(currentUser.role === 'read') return;
            if(confirm("Confirm deletion?")) { 
                const entry = db.find(x => x.id === id);
                auditLogs.unshift({ action: 'Record Deleted', client: entry.name, user: currentUser.uname, time: new Date().toLocaleString() });
                db = db.filter(x => x.id !== id); 
                saveAndRender(); 
            } 
        }

        function showAuditLogs() {
            document.getElementById('modalTitle').innerText = "History Logs";
            const canClear = currentUser.role === 'super';
            document.getElementById('modalContent').innerHTML = `
                <div class="space-y-2">${auditLogs.map(l => `<div class="p-3 bg-slate-50 rounded-xl text-[10px] border-l-4 border-indigo-500 shadow-sm"><div class="flex justify-between font-bold text-slate-700 uppercase"><span>${l.action}</span> <span>${l.time}</span></div><div class="text-slate-500 mt-1 font-medium">Client: ${l.client} | Executed By: ${l.user}</div></div>`).join('') || '<p class="text-center text-slate-400">No logs found</p>'}</div>
                ${(auditLogs.length > 0 && canClear) ? `<button onclick="clearLogs()" class="w-full mt-4 text-rose-500 text-[10px] font-black uppercase tracking-[2px]">Clear History (Admin Only)</button>` : ''}`;
            document.getElementById('modal').classList.remove('hidden');
        }

        function clearLogs() { if(confirm("Wipe logs?")) { auditLogs = []; saveAndRender(); showAuditLogs(); } }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        function updateNotifications() { const count = db.filter(x => !x.resolved && (x.expiry - new Date().getTime()) <= 0).length; document.getElementById('expiredCount').innerText = count; }
        
        function renderUserList() { 
            if(currentUser.role !== 'super') return;
            document.getElementById('userList').innerHTML = appUsers.map((u, i) => `<div class="bg-white p-3 rounded-xl border flex justify-between items-center shadow-sm"><span><b>${u.uname}</b> (${u.role})</span>${u.role !== 'super' ? `<button onclick="deleteUser(${i})" class="text-rose-500 hover:bg-rose-50 p-2 rounded-lg"><i class="fas fa-trash"></i></button>` : '<i class="fas fa-shield-alt text-indigo-400"></i>'}</div>`).join(''); 
        }
        
        function deleteUser(index) {
            if(currentUser.role !== 'super') return;
            if(confirm("Remove user?")) {
                appUsers.splice(index, 1);
                localStorage.setItem('ops_app_users', JSON.stringify(appUsers));
                renderUserList();
            }
        }

        function addUser() { 
            if(currentUser.role !== 'super') return;
            const u = document.getElementById('newUname').value, p = document.getElementById('newPass').value, r = document.getElementById('newRole').value; 
            if(!u || !p) return alert("Missing fields"); 
            appUsers.push({ uname: u, pass: p, role: r }); 
            localStorage.setItem('ops_app_users', JSON.stringify(appUsers)); 
            renderUserList(); 
            document.getElementById('newUname').value = ''; 
            document.getElementById('newPass').value = ''; 
        }

        function checkOthers(val) { document.getElementById('othersInput').classList.toggle('hidden', val !== 'Others'); }
        setInterval(() => { if(currentUser) { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); filterDatabase(); } }, 1000);
    </script>
</body>
</html>
